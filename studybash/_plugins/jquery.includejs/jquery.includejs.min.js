!function(e){e.includejs=function(){var t={},n={},i={},a={},s={},c={},r=0,u={ROOT:"/",JS_PATH:"_inc/js/",TPL_PATH:"_inc/tpl/",cache:!0},l=function(){return r++},o=function(e){return c[e]},f=function(e){c[e.id]=e},p=function(t){if("object"!==e.gettype(t).base)throw new Error("Invalid `incRequest`");t.isAborting=!0,_.each(t.ajaxRequests,function(t){"object"===e.gettype(t).base&&(t.abort(),t=null)}),t.ajaxRequests.splice(0,t.ajaxRequests.length),t.ajaxRequests=null},g=function(t){t="object"===e.gettype(t).base?t:{},t.isScript=!!t.isScript,t.fileName=t.fileName||"notset",t.id="number"===e.gettype(t.id).base?t.id:"notset";var n=o(t.id);if("object"!==e.gettype(n).base)throw new Error("Invalid `incRequest`");if("function"!==e.gettype(t.success).base)throw new Error("Invalid `success` callback");if("function"!==e.gettype(t.error).base)throw new Error("Invalid `error` callback");var i=t.isScript?u.JS_PATH:u.TPL_PATH,a=t.isScript?".js":".tpl.htm",s=t.isScript?"script":"html",c=e.ajax({url:u.ROOT+i+t.fileName+a,type:"GET",timeout:1e4,dataType:s,context:this}).done(function(e){n.isAborting||t.success(t,e)}).fail(function(e){n.isAborting||t.error(t,e)}).always(function(e,t,i){if(!n.isAborting){var a=null;a="success"===t?i:e,n.ajaxRequests=_.without(n.ajaxRequests,a)}});n.ajaxRequests.push(c)},d=function(i,s){var r={},u=e(s).filter("script[type='text/template']");u.each(function(t,n){r[e(n).attr("id")]=e(n).html()}),_.extend(t,r),waitList=a[i.fileName],_.each(waitList,function(e){var t=c[e];t.pendingTemplates=_.without(t.pendingTemplates,i.fileName),j(t)}),a[i.fileName]=null,delete a[i.fileName],n[i.fileName]=!0},h=function(e){waitList=s[e.fileName],_.each(waitList,function(t){var n=c[t];n.pendingJS=_.without(n.pendingJS,e.fileName),j(n)}),s[e.fileName]=null,delete s[e.fileName],i[e.fileName]=!0},b=function(e,t,n,i){var a=o(e.id);a.ajaxRequests=_.without(a.ajaxRequests,t),a.isAborting||(p(a),a.error(e,t,n,i))},j=function(e){e.pendingTemplates&&e.pendingTemplates.length||e.pendingJS&&e.pendingJS.length||(e.success(),c[e.id]=null,delete c[e.id])},m=function(t){var c=[],r=[];if(t.tpl.length&&(c=_.filter(t.tpl,function(e){return!n[e]})),t.js.length&&(r=_.filter(t.js,function(e){return!i[e]})),!c.length&&!r.length)return void t.success();t.waiting(),f(t);var l=incRequestPending=t.pendingTemplates=c,o=a,p=!1,j=d;do l.length&&(incRequestPending=l,_.each(incRequestPending,function(n){if(o[n])o[n].push(t.id);else{o[n]=[t.id];var i=!!e.ajaxSetup().cache;e.ajaxSetup({cache:!!u.cache}),g({isScript:p,fileName:n,id:t.id,success:j,error:b}),e.ajaxSetup({cache:i})}})),l===c?(l=incRequestPendeing=t.pendingJS=r,o=s,p=!0,j=h):l=null;while(l)},w=function(t){t="object"===e.gettype(t).base?t:{},t.tpl="array"===e.gettype(t.tpl).base?t.tpl:[],t.js="array"===e.gettype(t.js).base?t.js:[],t.waiting="function"===e.gettype(t.waiting).base?t.waiting:function(){},t.success="function"===e.gettype(t.success).base?t.success:function(){},t.error="function"===e.gettype(t.error).base?t.error:function(){};var n=_.extend({},t,{id:l(),isAborting:!1,ajaxRequests:[]});m(n)},y=function(n,i){if(!t[n])return console.error("`tplName` not found in $.includejs dictionary: "+n),null;i="object"===e.gettype(i).base?i:{};var a=(new Date).getFullYear();return _.extend(i,{ROOT:u.ROOT,YEAR:a}),a=null,_.template(t[n])(i)};return{settings:u,include:w,getTemplate:y}}()}(jQuery);